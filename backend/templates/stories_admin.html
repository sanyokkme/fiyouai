<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>–ö–µ—Ä—É–≤–∞–Ω–Ω—è Stories | NutritionAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #4ADE80;
            color: #4ADE80;
        }

        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #9CA3AF;
        }

        /* –ö—É—Ä—Å–æ—Ä –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è */
        .cursor-grab {
            cursor: grab;
        }

        .cursor-grab:active {
            cursor: grabbing;
        }

        /* –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—ñ */
        .sortable-ghost {
            opacity: 0.4;
            border: 2px dashed #4ADE80;
        }
    </style>
</head>

<body class="bg-[#0A0A0A] text-white p-8 font-sans">
    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-green-400">–ö–µ—Ä—É–≤–∞–Ω–Ω—è Stories</h1>
            <div class="flex gap-4">
                <a href="/admin/dashboard" class="text-gray-400 hover:text-white flex items-center gap-2 transition">
                    <i data-lucide="arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </header>

        <div class="bg-[#1A1A1A] p-6 rounded-xl border border-gray-800 mb-10">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle" class="text-green-400"></i> –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É
            </h2>
            <div class="flex gap-6 mb-4 border-b border-gray-800">
                <button onclick="switchTab('url', 'add')" id="tab-url-add"
                    class="pb-2 text-sm font-bold tab-active transition">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
                <button onclick="switchTab('file', 'add')" id="tab-file-add"
                    class="pb-2 text-sm font-bold tab-inactive transition">üìÅ –§–æ—Ç–æ</button>
            </div>
            <form action="/admin/add_story" method="POST" enctype="multipart/form-data"
                class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <div id="input-url-block-add">
                        <input type="text" name="image_url" id="image_url_input_add" placeholder="URL –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è..."
                            class="w-full bg-[#0A0A0A] border border-gray-700 rounded-lg p-3 outline-none focus:border-green-400">
                    </div>
                    <div id="input-file-block-add" class="hidden">
                        <input type="file" name="image_file" accept="image/*"
                            class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-green-500/20 file:text-green-400 file:border-0">
                    </div>
                </div>
                <div>
                    <input type="text" name="title" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–æ—Ä—ñ–∑..." required
                        class="w-full bg-[#0A0A0A] border border-gray-700 rounded-lg p-3 outline-none focus:border-green-400">
                </div>
                <button type="submit"
                    class="bg-green-500 hover:bg-green-600 text-black font-bold py-3 px-6 rounded-lg transition">–î–æ–¥–∞—Ç–∏</button>
            </form>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-300">–ê–∫—Ç–∏–≤–Ω—ñ Stories ({{ stories|length }})</h2>
            <p class="text-xs text-gray-500 flex items-center gap-1"><i data-lucide="move"></i> –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏
                –ø–æ—Ä—è–¥–æ–∫</p>
        </div>

        <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for story in stories %}
            <div class="relative group bg-[#1A1A1A] rounded-xl overflow-hidden border border-gray-800 flex flex-col cursor-grab shadow-lg hover:border-gray-600 transition"
                data-id="{{ story.id }}">

                <div class="h-64 overflow-hidden relative">
                    <img src="{{ story.image_url }}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
                    <div class="absolute bottom-3 left-3 right-3 pointer-events-none">
                        <p class="font-bold text-white text-sm leading-tight">{{ story.title }}</p>
                    </div>
                    <div
                        class="absolute top-2 left-2 bg-black/50 p-1 rounded backdrop-blur-md opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="grip-horizontal" class="text-white w-4 h-4"></i>
                    </div>
                </div>

                <div class="p-3 flex justify-between items-center bg-[#151515] border-t border-gray-800">
                    <button onclick="openEditModal('{{ story.id }}', '{{ story.title }}', '{{ story.image_url }}')"
                        class="flex items-center gap-1 text-xs text-gray-400 hover:text-green-400 transition font-bold">
                        <i data-lucide="edit-3" class="w-3 h-3"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                    </button>

                    <form action="/admin/delete_story" method="POST">
                        <input type="hidden" name="story_id" value="{{ story.id }}">
                        <button type="submit" class="text-red-400 hover:text-red-300 transition"
                            onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-[#1A1A1A] p-8 rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl relative">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x"></i>
            </button>

            <h2 class="text-2xl font-bold mb-6 text-green-400">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ Stories</h2>

            <form action="/admin/edit_story" method="POST" enctype="multipart/form-data" class="space-y-5">
                <input type="hidden" name="story_id" id="edit_story_id">

                <div class="flex justify-center mb-4">
                    <img id="edit_preview" src="" class="h-32 rounded-lg border border-gray-600 object-cover">
                </div>

                <div class="flex gap-6 border-b border-gray-800">
                    <button type="button" onclick="switchTab('url', 'edit')" id="tab-url-edit"
                        class="pb-2 text-sm font-bold tab-active transition">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
                    <button type="button" onclick="switchTab('file', 'edit')" id="tab-file-edit"
                        class="pb-2 text-sm font-bold tab-inactive transition">–ù–æ–≤–µ —Ñ–æ—Ç–æ</button>
                </div>

                <div id="input-url-block-edit">
                    <input type="text" name="image_url" id="edit_image_url"
                        placeholder="–ó–∞–ª–∏—à—Ç–µ –ø—É—Å—Ç–∏–º, —è–∫—â–æ –Ω–µ –∑–º—ñ–Ω—é—î—Ç–µ"
                        class="w-full bg-[#0A0A0A] border border-gray-700 rounded-lg p-3 outline-none focus:border-green-400">
                </div>
                <div id="input-file-block-edit" class="hidden">
                    <input type="file" name="image_file" accept="image/*"
                        class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-green-500/20 file:text-green-400 file:border-0">
                </div>

                <div>
                    <label class="block text-gray-400 text-sm mb-1">–¢–µ–∫—Å—Ç</label>
                    <input type="text" name="title" id="edit_title" required
                        class="w-full bg-[#0A0A0A] border border-gray-700 rounded-lg p-3 outline-none focus:border-green-400">
                </div>

                <button type="submit"
                    class="w-full bg-green-500 hover:bg-green-600 text-black font-bold py-3 rounded-lg transition">–ó–±–µ—Ä–µ–≥—Ç–∏
                    –∑–º—ñ–Ω–∏</button>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø DRAG & DROP
        const grid = document.getElementById('stories-grid');
        new Sortable(grid, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                // –ó–±–∏—Ä–∞—î–º–æ –Ω–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ ID
                const itemEls = grid.children;
                const newOrder = [];
                for (let i = 0; i < itemEls.length; i++) {
                    newOrder.push(itemEls[i].getAttribute('data-id'));
                }

                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch('/admin/reorder_stories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: newOrder })
                }).then(res => {
                    if (res.ok) console.log("Order saved");
                    else alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—Ä—è–¥–∫—É");
                });
            }
        });

        // 2. –í–ö–õ–ê–î–ö–ò (–¥–ª—è Add —Ç–∞ Edit)
        function switchTab(type, context) {
            const urlBlock = document.getElementById(`input-url-block-${context}`);
            const fileBlock = document.getElementById(`input-file-block-${context}`);
            const tabUrl = document.getElementById(`tab-url-${context}`);
            const tabFile = document.getElementById(`tab-file-${context}`);
            const urlInput = context === 'add' ? document.getElementById('image_url_input_add') : document.getElementById('edit_image_url');

            if (type === 'url') {
                urlBlock.classList.remove('hidden');
                fileBlock.classList.add('hidden');
                tabUrl.classList.add('tab-active'); tabUrl.classList.remove('tab-inactive');
                tabFile.classList.add('tab-inactive'); tabFile.classList.remove('tab-active');
            } else {
                urlBlock.classList.add('hidden');
                fileBlock.classList.remove('hidden');
                tabFile.classList.add('tab-active'); tabFile.classList.remove('tab-inactive');
                tabUrl.classList.add('tab-inactive'); tabUrl.classList.remove('tab-active');
                if (urlInput) urlInput.value = ''; // –û—á–∏—Å—Ç–∫–∞
            }
        }

        // 3. –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û
        function openEditModal(id, title, imageUrl) {
            document.getElementById('edit_story_id').value = id;
            document.getElementById('edit_title').value = title;
            document.getElementById('edit_image_url').value = imageUrl;
            document.getElementById('edit_preview').src = imageUrl;

            // –°–∫–∏–¥–∞—î–º–æ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞ URL –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            switchTab('url', 'edit');

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }
    </script>
</body>

</html>